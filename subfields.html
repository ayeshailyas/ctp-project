<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Research Trends | Timeline View</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="chatbot/chatbot.css" />

    <style>
      :root {
        --bg-color: #0f172a;
        --panel-bg: rgba(15, 23, 42, 0.85);
        --accent-primary: #38bdf8;
        --accent-secondary: #818cf8;
        --text-main: #f1f5f9;
        --text-muted: #94a3b8;
        --border-color: rgba(148, 163, 184, 0.15);
      }

      * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }

      body {
        margin: 0;
        overflow: hidden;
        background-color: var(--bg-color);
        background-image: radial-gradient(circle at 50% 50%, #1e293b 0%, #0f172a 100%);
        font-family: 'Inter', sans-serif;
        color: var(--text-main);
      }

      /* --- LAYOUT --- */
      #graph-container { width: 100vw; height: 100vh; }

      /* --- PANELS --- */
      .panel {
        position: absolute;
        background: var(--panel-bg);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        transition: all 0.3s ease;
      }

      /* Top Left: Controls */
      #control-panel { top: 24px; left: 24px; width: 240px; z-index: 10; }
      
      /* Top Right: Info */
      #info-panel { top: 24px; right: 24px; width: 280px; z-index: 10; }

      /* Bottom Center: Timeline */
      #timeline-panel {
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        width: 600px;
        max-width: 90%;
        display: flex;
        flex-direction: column;
        align-items: center;
        z-index: 20;
        padding: 15px 25px;
      }

      /* Bottom Left: Legend */
      #legend-panel {
        bottom: 30px;
        left: 24px;
        width: 200px;
        z-index: 10;
        padding: 15px;
      }

      /* Headings & Text */
      h2 { font-size: 14px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-bottom: 12px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
      h2::before { content: ''; width: 6px; height: 6px; background: var(--accent-primary); border-radius: 50%; box-shadow: 0 0 8px var(--accent-primary); }
      p { font-size: 13px; color: var(--text-muted); line-height: 1.5; margin-bottom: 8px; }
      .metric-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border-color); font-size: 12px; }
      .metric-val { color: var(--text-main); font-weight: 600; font-family: monospace; }

      /* --- SLIDER UI --- */
      .timeline-header {
        width: 100%;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }
      #current-year-display {
        font-size: 24px;
        font-weight: 700;
        color: var(--accent-primary);
        text-shadow: 0 0 15px rgba(56, 189, 248, 0.4);
        font-variant-numeric: tabular-nums;
      }
      
      input[type=range] {
        -webkit-appearance: none;
        width: 100%;
        background: transparent;
      }
      input[type=range]::-webkit-slider-thumb {
        -webkit-appearance: none;
        height: 20px;
        width: 20px;
        border-radius: 50%;
        background: var(--accent-primary);
        cursor: pointer;
        margin-top: -8px;
        box-shadow: 0 0 10px var(--accent-primary);
        transition: transform 0.1s;
      }
      input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.2); }
      input[type=range]::-webkit-slider-runnable-track {
        width: 100%;
        height: 4px;
        cursor: pointer;
        background: rgba(255,255,255,0.1);
        border-radius: 2px;
      }
      
      .timeline-labels {
        width: 100%;
        display: flex;
        justify-content: space-between;
        margin-top: 8px;
        font-size: 10px;
        color: var(--text-muted);
      }

      /* --- LEGEND UI --- */
      .legend-item { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; font-size: 11px; color: var(--text-muted); }
      .legend-dot { width: 10px; height: 10px; border-radius: 50%; }
      .legend-line { width: 20px; height: 2px; background: var(--text-muted); opacity: 0.5; }
      .legend-section { margin-top: 12px; padding-top: 8px; border-top: 1px solid var(--border-color); }
      .legend-title { font-size: 10px; text-transform: uppercase; color: var(--accent-secondary); margin-bottom: 6px; letter-spacing: 0.5px; }

      /* --- BUTTONS --- */
      button.ctrl-btn {
        width: 100%;
        padding: 10px;
        background: rgba(255,255,255,0.05);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-main);
        cursor: pointer;
        font-size: 12px;
        margin-top: 8px;
        transition: all 0.2s;
        font-family: 'Inter', sans-serif;
      }
      button.ctrl-btn:hover { background: rgba(255,255,255,0.1); transform: translateY(-1px); }
      button.ctrl-btn.primary { background: rgba(56, 189, 248, 0.15); border-color: var(--accent-primary); color: var(--accent-primary); }
      button.ctrl-btn.primary:hover { background: rgba(56, 189, 248, 0.25); }
      
      /* --- LOADING --- */
      #loading {
        position: absolute; inset: 0; background: var(--bg-color);
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        z-index: 100; transition: opacity 0.5s;
      }
      .loader {
        width: 40px; height: 40px; border: 2px solid var(--border-color);
        border-top-color: var(--accent-primary); border-radius: 50%;
        animation: spin 0.8s linear infinite; margin-bottom: 16px;
      }
      @keyframes spin { to { transform: rotate(360deg); } }

      /* --- D3 GRAPH --- */
      .node { stroke: var(--bg-color); stroke-width: 1.5px; transition: all 0.3s; cursor: pointer; }
      .node:hover { stroke: #fff; stroke-width: 2px; filter: drop-shadow(0 0 8px var(--accent-primary)); }
      .link { stroke: var(--text-muted); stroke-opacity: 0.2; transition: stroke-opacity 0.3s; pointer-events: none; }
      .label { font-size: 10px; fill: var(--text-muted); text-anchor: middle; pointer-events: none; font-weight: 500; text-shadow: 0 2px 4px #000; font-family: 'Inter', sans-serif; }

      /* Tooltip */
      #tooltip {
        position: absolute; background: rgba(15, 23, 42, 0.95);
        padding: 12px; border-radius: 8px; border: 1px solid var(--border-color);
        pointer-events: none; display: none; z-index: 200; min-width: 160px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5); backdrop-filter: blur(4px);
      }

      /* --- CHATBOT THEME OVERRIDES --- */
      /* These styles force the chatbot to match the Graph View theme */
      .chat-button {
        background-color: var(--accent-primary) !important;
        box-shadow: 0 0 15px rgba(56, 189, 248, 0.4) !important;
        bottom: 30px !important;
        right: 30px !important;
      }
      .chat-modal {
        background: var(--panel-bg) !important;
        backdrop-filter: blur(12px) !important;
        -webkit-backdrop-filter: blur(12px) !important;
        border: 1px solid var(--border-color) !important;
        border-radius: 16px !important;
        font-family: 'Inter', sans-serif !important;
        box-shadow: 0 20px 40px rgba(0,0,0,0.4) !important;
      }
      .chat-modal-header {
        border-bottom: 1px solid var(--border-color) !important;
      }
      .chat-modal-header h3 {
        color: var(--text-main) !important;
        font-weight: 600 !important;
      }
      .chat-input {
        background: rgba(255,255,255,0.05) !important;
        border: 1px solid var(--border-color) !important;
        color: var(--text-main) !important;
        border-radius: 8px !important;
      }
      .chat-input:focus {
        border-color: var(--accent-primary) !important;
      }
      .chat-send-btn {
        background: var(--accent-primary) !important;
        color: #0f172a !important;
        font-weight: 600 !important;
        border-radius: 8px !important;
      }
      .message.user .message-bubble {
        background: var(--accent-primary) !important;
        color: #0f172a !important;
      }
      .message.ai .message-bubble {
        background: rgba(255,255,255,0.05) !important;
        border: 1px solid var(--border-color) !important;
        color: var(--text-main) !important;
      }
      .suggested-question-btn {
        background: rgba(255,255,255,0.05) !important;
        border: 1px solid var(--border-color) !important;
        color: var(--accent-primary) !important;
        border-radius: 6px !important;
      }
      .suggested-question-btn:hover {
        background: rgba(56, 189, 248, 0.1) !important;
        border-color: var(--accent-primary) !important;
      }
    </style>
  </head>
  <body>

    <div id="loading">
      <div class="loader"></div>
      <div style="font-size: 12px; letter-spacing: 1px; color: var(--text-muted);">LOADING TIMELINE DATA</div>
    </div>

    <div id="graph-container"></div>

    <div id="control-panel" class="panel">
      <h2>Controls</h2>
      <button id="back-btn" class="ctrl-btn primary" style="display:none;">‚Üê Back to Overview</button>
      <button id="reset-cam" class="ctrl-btn">Reset Camera</button>
      <button id="toggle-labels" class="ctrl-btn">Toggle Labels</button>
      <button class="ctrl-btn" onclick="window.location.href='/index.html'">Switch to Globe View</button>
    </div>

    <div id="info-panel" class="panel">
      <h2 id="info-title">Analysis</h2>
      <div id="info-content">
        <p id="info-desc">Exploring the evolution of research subfields over time.</p>
        <div class="metric-row">
           <span>Active Nodes</span>
           <span class="metric-val" id="stat-nodes">0</span>
        </div>
        <div class="metric-row">
           <span>Total Works (Year)</span>
           <span class="metric-val" id="stat-works">0</span>
        </div>
      </div>
    </div>

    <div id="timeline-panel" class="panel">
      <div class="timeline-header">
        <span style="font-size: 11px; color: var(--text-muted); font-weight: 600;">YEAR SELECTOR</span>
        <div id="current-year-display">2024</div>
      </div>
      
      <input type="range" id="year-slider" min="2005" max="2024" step="1" value="2024">
      
      <div class="timeline-labels">
        <span id="min-year-label">2005</span>
        <span id="max-year-label">2024</span>
      </div>
    </div>

    <div id="legend-panel" class="panel">
      <h2>Legend</h2>
      
      <div class="legend-title">Volume</div>
      <div class="legend-item">
        <div class="legend-dot" style="background: #38bdf8; box-shadow: 0 0 8px #38bdf8;"></div>
        <span>High (>50k Works)</span>
      </div>
      <div class="legend-item">
        <div class="legend-dot" style="background: #818cf8;"></div>
        <span>Mid (>20k Works)</span>
      </div>
      <div class="legend-item">
        <div class="legend-dot" style="background: #64748b;"></div>
        <span>Standard</span>
      </div>

      <div class="legend-section">
        <div class="legend-title">Relations</div>
        <div class="legend-item">
          <div class="legend-line"></div>
          <span>Semantic Similarity</span>
        </div>
      </div>
      
      <div class="legend-section">
        <div class="legend-title">Interaction</div>
        <div class="legend-item">
          <span style="font-size: 10px;">Click Subfield to see Topics</span>
        </div>
      </div>
    </div>

    <div id="tooltip">
      <div style="color: var(--accent-primary); font-weight: 600; margin-bottom: 4px;" id="tooltip-title"></div>
      <div style="font-size: 12px; color: var(--text-main);">Works: <span id="tooltip-val" style="font-family: monospace;"></span></div>
    </div>

    <div id="chatbot-container"></div>

    <script src="https://d3js.org/d3.v7.min.js"></script>

    <script src="chatbot/chatbot.js"></script>

    <script>
      const API_BASE = "http://localhost:5000/api";
      
      // State
      let svg, g, simulation;
      let width, height;
      let currentYear = 2024;
      let currentView = 'subfields'; // 'subfields' or 'topics'
      let showLabels = true;
      let nodeData = [], linkData = [];
      let yearCache = {}; // Cache for SUBFIELDS view only
      
      // --- INIT ---
      async function init() {
        try {
          const res = await fetch(`${API_BASE}/trends/years`);
          if(!res.ok) throw new Error("API Error");
          const data = await res.json();
          const years = data.years;
          
          if(!years || years.length === 0) throw new Error("No yearly data found");

          const slider = document.getElementById('year-slider');
          const minYear = Math.min(...years);
          const maxYear = Math.max(...years);
          
          slider.min = minYear;
          slider.max = maxYear;
          slider.value = maxYear;
          currentYear = maxYear;
          
          document.getElementById('min-year-label').textContent = minYear;
          document.getElementById('max-year-label').textContent = maxYear;
          document.getElementById('current-year-display').textContent = maxYear;

          setupGraph();
          await loadYearData(maxYear);

          slider.addEventListener('input', (e) => {
            const year = parseInt(e.target.value);
            document.getElementById('current-year-display').textContent = year;
            currentYear = year;
          });

          slider.addEventListener('change', (e) => {
            const year = parseInt(e.target.value);
            if(currentView === 'subfields') {
                loadYearData(year);
            } else {
                document.getElementById('back-btn').click();
                loadYearData(year);
            }
          });

          document.getElementById('loading').style.opacity = 0;
          setTimeout(() => document.getElementById('loading').style.display = 'none', 500);

        } catch (e) {
          console.error(e);
          document.getElementById('loading').innerHTML = `<div style="color:#f87171">DATA ERROR<br><small>${e.message}</small></div>`;
        }
      }

      // --- DATA LOADING (SUBFIELDS) ---
      async function loadYearData(year) {
        if(yearCache[year]) {
          updateGraph(yearCache[year]);
          return;
        }
        try {
          const res = await fetch(`${API_BASE}/trends/graph?year=${year}`);
          const data = await res.json();
          if(data.error) return;
          yearCache[year] = data;
          updateGraph(data);
        } catch(e) {
          console.error("Fetch error", e);
        }
      }

      // --- DATA LOADING (TOPICS DRILL DOWN) ---
      async function drillDown(node) {
          const loading = document.getElementById('loading');
          loading.style.display = 'flex';
          loading.style.opacity = 1;
          loading.querySelector('div:last-child').textContent = `FETCHING TOPICS (${currentYear})`;

          try {
              const res = await fetch(`${API_BASE}/trends/topics?year=${currentYear}&subfield_id=${node.id}`);
              const data = await res.json();
              
              if (data.error) throw new Error(data.error);

              currentView = 'topics';
              document.getElementById('back-btn').style.display = 'block';
              
              // Update Info
              document.getElementById('info-title').textContent = 'Drill Down';
              document.getElementById('info-desc').innerHTML = `Topics within <strong>${node.name}</strong> in <strong>${currentYear}</strong>.`;

              updateGraph(data);

          } catch(e) {
              console.error(e);
              alert("No topic data available for this year/subfield combination.");
          } finally {
              loading.style.opacity = 0;
              setTimeout(() => loading.style.display = 'none', 500);
          }
      }

      // --- GRAPH SETUP ---
      function setupGraph() {
        width = window.innerWidth;
        height = window.innerHeight;
        const container = document.getElementById('graph-container');

        svg = d3.select(container).append("svg")
            .attr("width", width)
            .attr("height", height)
            .on("click", (e) => {
               if(e.target.tagName === 'svg') resetHighlights();
            });

        g = svg.append("g");

        const zoom = d3.zoom()
            .scaleExtent([0.1, 4])
            .on("zoom", (e) => g.attr("transform", e.transform));
        svg.call(zoom);

        simulation = d3.forceSimulation()
            .force("link", d3.forceLink().id(d => d.id).distance(120))
            .force("charge", d3.forceManyBody().strength(-400))
            .force("center", d3.forceCenter(width / 2, height / 2))
            .force("collide", d3.forceCollide().radius(d => d.size + 10).iterations(2))
            .alphaDecay(0.04)
            .velocityDecay(0.4);
            
        window.resetCamera = () => svg.transition().duration(750).call(zoom.transform, d3.zoomIdentity);
      }

      // --- GRAPH UPDATE ---
      function updateGraph(data) {
        nodeData = data.nodes;
        linkData = data.links;

        document.getElementById('stat-nodes').textContent = nodeData.length;
        const totalWorks = nodeData.reduce((sum, n) => sum + n.us_works_count, 0);
        document.getElementById('stat-works').textContent = totalWorks.toLocaleString();

        // LINKS
        const links = g.selectAll(".link")
            .data(linkData, d => `${d.source.id || d.source}-${d.target.id || d.target}`);

        links.exit().transition().duration(300).style("opacity", 0).remove();

        const linksEnter = links.enter().append("line")
            .attr("class", "link")
            .attr("stroke-width", d => Math.sqrt(d.similarity) * 3);

        const allLinks = linksEnter.merge(links);

        // NODES
        const nodes = g.selectAll(".node")
            .data(nodeData, d => d.id);

        nodes.exit().transition().duration(500).attr("r", 0).style("opacity", 0).remove();

        const nodesEnter = nodes.enter().append("circle")
            .attr("class", "node")
            .attr("r", 0)
            .attr("fill", d => getNodeColor(d.us_works_count))
            .call(d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended));
        
        nodesEnter.on("mouseover", handleMouseOver)
                  .on("mouseout", handleMouseOut)
                  .on("click", (event, d) => {
                      if(currentView === 'subfields') drillDown(d);
                  });

        const allNodes = nodesEnter.merge(nodes);
        allNodes.transition().duration(750)
            .attr("r", d => d.size)
            .attr("fill", d => getNodeColor(d.us_works_count));

        // LABELS
        const labels = g.selectAll(".label")
            .data(nodeData, d => d.id);

        labels.exit().remove();

        const labelsEnter = labels.enter().append("text")
            .attr("class", "label")
            .text(d => d.name)
            .attr("dy", d => d.size + 15)
            .style("opacity", 0);

        const allLabels = labelsEnter.merge(labels);
        allLabels.text(d => d.name)
            .transition().duration(750)
            .attr("dy", d => d.size + 15)
            .style("opacity", showLabels ? 0.8 : 0);

        // RESTART SIM
        simulation.nodes(nodeData).on("tick", ticked);
        simulation.force("link").links(linkData);
        simulation.alpha(0.5).restart();

        function ticked() {
            allLinks
                .attr("x1", d => d.source.x)
                .attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x)
                .attr("y2", d => d.target.y);

            allNodes
                .attr("cx", d => d.x)
                .attr("cy", d => d.y);

            allLabels
                .attr("x", d => d.x)
                .attr("y", d => d.y);
        }
      }

      // --- INTERACTIONS ---
      function handleMouseOver(event, d) {
        d3.selectAll(".node").style("opacity", 0.2);
        d3.selectAll(".link").style("opacity", 0.05);
        d3.selectAll(".label").style("opacity", 0.1);
        
        const connected = new Set([d.id]);
        linkData.forEach(l => {
            if(l.source.id === d.id) connected.add(l.target.id);
            if(l.target.id === d.id) connected.add(l.source.id);
        });

        d3.selectAll(".node").filter(n => connected.has(n.id)).style("opacity", 1);
        d3.selectAll(".label").filter(n => connected.has(n.id)).style("opacity", 1);
        
        const tooltip = document.getElementById('tooltip');
        tooltip.style.display = 'block';
        tooltip.style.left = (event.pageX + 15) + 'px';
        tooltip.style.top = (event.pageY + 15) + 'px';
        document.getElementById('tooltip-title').textContent = d.name;
        document.getElementById('tooltip-val').textContent = d.us_works_count.toLocaleString();
      }

      function handleMouseOut() {
        resetHighlights();
        document.getElementById('tooltip').style.display = 'none';
      }

      function resetHighlights() {
        d3.selectAll(".node").style("opacity", 1);
        d3.selectAll(".link").style("opacity", null);
        d3.selectAll(".label").style("opacity", showLabels ? 0.8 : 0);
      }

      function getNodeColor(count) {
        if(count > 50000) return "#38bdf8"; 
        if(count > 20000) return "#818cf8"; 
        return "#64748b"; 
      }

      function dragstarted(event, d) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        d.fx = d.x; d.fy = d.y;
      }
      function dragged(event, d) { d.fx = event.x; d.fy = event.y; }
      function dragended(event, d) {
        if (!event.active) simulation.alphaTarget(0);
        d.fx = null; d.fy = null;
      }

      document.getElementById('back-btn').onclick = () => {
          currentView = 'subfields';
          document.getElementById('back-btn').style.display = 'none';
          document.getElementById('info-title').textContent = 'Overview';
          document.getElementById('info-desc').textContent = 'Exploring the evolution of research subfields over time.';
          loadYearData(currentYear);
      };
      
      document.getElementById('reset-cam').onclick = window.resetCamera;
      document.getElementById('toggle-labels').onclick = () => {
        showLabels = !showLabels;
        d3.selectAll(".label").style("display", showLabels ? "block" : "none");
      };
      window.onresize = () => {
        width = window.innerWidth; height = window.innerHeight;
        d3.select("svg").attr("width", width).attr("height", height);
        simulation.force("center", d3.forceCenter(width / 2, height / 2)).restart();
      };

      init();
    </script>
  </body>
</html>
